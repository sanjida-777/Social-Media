{% extends "base.html" %}

{% block title %}Conversation with {{ user.username }}{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/messages.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/socket-styles.css') }}">
{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-md-3">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Messages</h5>
            </div>
            <div class="list-group list-group-flush">
                <a href="{{ url_for('messages.inbox') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-inbox me-2"></i> Inbox
                </a>
                <a href="{{ url_for('messages.sent') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-paper-plane me-2"></i> Sent
                </a>
                <a href="{{ url_for('messages.new_message') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-plus me-2"></i> New Message
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center conversation-header">
                    <img src="{{ url_for('static', filename='img/profile_pics/' + user.profile_image) }}"
                         alt="Profile Picture" class="rounded-circle profile-pic-small me-2">
                    <h5 class="mb-0">{{ user.first_name }} {{ user.last_name }}</h5>
                    <span class="user-status-indicator ms-2" title="Offline"></span>
                </div>
                <div class="d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-danger btn-sm dropdown-toggle" type="button" id="deleteDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-trash-alt me-1"></i> Delete Conversation
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="deleteDropdown">
                            <li>
                                <form action="{{ url_for('messages.delete_conversation', username=user.username) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this conversation? You can still see that messages were deleted.')">
                                    <button type="submit" class="dropdown-item">
                                        <i class="fas fa-trash me-1"></i> Normal Delete
                                    </button>
                                </form>
                            </li>
                            <li>
                                <form action="{{ url_for('messages.delete_conversation', username=user.username) }}" method="POST" onsubmit="return confirm('WARNING: This will permanently delete all your messages with no trace. This action cannot be undone.')">
                                    <input type="hidden" name="hard_delete" value="true">
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="fas fa-fire me-1"></i> Permanent Delete (No Trace)
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                    <a href="{{ url_for('profile.view', username=user.username) }}" class="btn btn-light btn-sm">
                        <i class="fas fa-user me-1"></i> View Profile
                    </a>
                </div>
            </div>
            <div class="card-body conversation-container">
                <div class="offline-message">
                    <i class="fas fa-exclamation-triangle me-2"></i> You are currently offline. Messages will be sent when you reconnect.
                </div>
                <div class="offline-indicator" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i> Connection lost. Reconnecting...
                </div>
                <div class="conversation">
                    {% for message in messages.items %}
                    <div class="message {% if message.sender == current_user %}message-sent{% else %}message-received{% endif %}" data-message-id="{{ message.id }}">
                        <div class="message-content {% if message.deleted %}message-deleted{% endif %} {% if message.edited %}message-edited{% endif %}">
                            {% if message.deleted %}
                                <i class="fas fa-ban me-1"></i> This message was deleted
                            {% else %}
                                {{ message.content }}

                                {% if message.attachment_filename %}
                                <div class="message-attachment mt-2">
                                    {% if message.attachment_type == 'image' %}
                                    <a href="{{ url_for('static', filename='uploads/message_attachments/' + message.attachment_filename) }}" target="_blank">
                                        <img src="{{ url_for('static', filename='uploads/message_attachments/' + message.attachment_filename) }}"
                                             alt="Attachment" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                    </a>
                                    {% elif message.attachment_type == 'pdf' %}
                                    <a href="{{ url_for('static', filename='uploads/message_attachments/' + message.attachment_filename) }}"
                                       class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="fas fa-file-pdf me-1"></i> View PDF
                                    </a>
                                    {% elif message.attachment_type == 'document' %}
                                    <a href="{{ url_for('static', filename='uploads/message_attachments/' + message.attachment_filename) }}"
                                       class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="fas fa-file-word me-1"></i> View Document
                                    </a>
                                    {% else %}
                                    <a href="{{ url_for('static', filename='uploads/message_attachments/' + message.attachment_filename) }}"
                                       class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="fas fa-file me-1"></i> Download File
                                    </a>
                                    {% endif %}
                                </div>
                                {% endif %}
                            {% endif %}

                            <div class="message-time">
                                {{ message.created_at.strftime('%I:%M %p | %b %d') }}
                                {% if message.edited %}
                                <span class="text-muted ms-1">(edited)</span>
                                {% endif %}
                                {% if message.sender == current_user %}
                                    {% if message.read %}
                                    <span class="message-status read-status ms-1" title="Read {{ message.read_at.strftime('%I:%M %p | %b %d') if message.read_at else '' }}"><i class="fas fa-check-double"></i></span>
                                    {% elif message.delivered %}
                                    <span class="message-status delivered-status ms-1" title="Delivered {{ message.delivered_at.strftime('%I:%M %p | %b %d') if message.delivered_at else '' }}"><i class="fas fa-check"></i></span>
                                    {% else %}
                                    <span class="message-status sent-status ms-1" title="Sent"><i class="fas fa-paper-plane"></i></span>
                                    {% endif %}

                                    <!-- Message actions dropdown -->
                                    {% if not message.deleted %}
                                    <div class="message-actions dropdown">
                                        <button class="btn btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" href="{{ url_for('messages.edit_message', message_id=message.id) }}">
                                                    <i class="fas fa-edit me-2"></i> Edit
                                                </a>
                                            </li>
                                            <li>
                                                <div class="dropdown-submenu">
                                                    <button class="dropdown-item" type="button">
                                                        <i class="fas fa-trash-alt me-2"></i> Delete <i class="fas fa-caret-right float-end mt-1"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end">
                                                        <li>
                                                            <form action="{{ url_for('messages.delete_message', message_id=message.id) }}" method="POST">
                                                                <button type="submit" class="dropdown-item">
                                                                    <i class="fas fa-trash me-2"></i> Normal Delete
                                                                </button>
                                                            </form>
                                                        </li>
                                                        <li>
                                                            <form action="{{ url_for('messages.delete_message', message_id=message.id) }}" method="POST">
                                                                <input type="hidden" name="hard_delete" value="true">
                                                                <button type="submit" class="dropdown-item text-danger">
                                                                    <i class="fas fa-fire me-2"></i> Permanent Delete (No Trace)
                                                                </button>
                                                            </form>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Message Form -->
                <form class="mt-3" id="message-form">
                    {{ form.hidden_tag() }}
                    {{ form.recipient(type="hidden") }}
                    {{ form.client_message_id(type="hidden") }}
                    <div class="input-group">
                        {{ form.content(class="form-control", placeholder="Type a message...", rows="1", id="message-input") }}
                        <label for="attachment-upload" class="btn btn-outline-secondary" title="Add attachment">
                            <i class="fas fa-paperclip"></i>
                        </label>
                        {{ form.attachment(class="d-none", id="attachment-upload") }}
                        <button type="submit" class="btn btn-primary" id="send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div id="attachment-preview" class="mt-2 d-none">
                        <div class="d-flex align-items-center">
                            <span class="me-2"><i class="fas fa-paperclip"></i> <span id="attachment-name"></span></span>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="remove-attachment">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="typing-indicator mt-1 d-none">
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/messages.js') }}"></script>
<script src="{{ url_for('static', filename='js/socket-client.js') }}"></script>
<script>
    // Generate UUID for client message ID
    function uuid4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // Function to set up attachment handling
    function setupAttachmentHandling() {
        const attachmentInput = document.getElementById('attachment-upload');
        const attachmentPreview = document.getElementById('attachment-preview');
        const attachmentName = document.getElementById('attachment-name');
        const removeAttachmentBtn = document.getElementById('remove-attachment');

        if (!attachmentInput || !attachmentPreview || !attachmentName || !removeAttachmentBtn) return;

        // Handle file selection
        attachmentInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                const file = this.files[0];

                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size exceeds 10MB limit. Please choose a smaller file.');
                    this.value = '';
                    return;
                }

                // Display file name
                attachmentName.textContent = file.name;
                attachmentPreview.classList.remove('d-none');
            } else {
                // No file selected
                attachmentPreview.classList.add('d-none');
            }
        });

        // Handle remove attachment
        removeAttachmentBtn.addEventListener('click', function() {
            attachmentInput.value = '';
            attachmentPreview.classList.add('d-none');
        });
    }

    // Scroll to bottom of conversation on page load
    document.addEventListener('DOMContentLoaded', function() {
        const conversationContainer = document.querySelector('.conversation');
        conversationContainer.scrollTop = conversationContainer.scrollHeight;

        // Set up real-time message updates
        setupMessagePolling();

        // Set up typing indicator
        setupTypingIndicator();

        // Set up message form with AJAX submission
        setupMessageForm();

        // Set up attachment handling
        setupAttachmentHandling();
    });

    // Function to set up real-time message updates
    function setupMessagePolling() {
        const username = '{{ user.username }}';
        const conversation = document.querySelector('.conversation');
        let lastMessageId = getLastMessageId();

        // Initialize WebSocket connection
        window.messageSyncState = {
            recipient: username,
            lastMessageId: lastMessageId,
            lastPollTime: Date.now(),
            isPolling: false
        };

        // Set up WebSocket event handlers
        document.addEventListener('socket-connected', function() {
            // Join conversation room
            joinConversation(username);

            // Mark all unread messages as read
            markAllMessagesAsRead();
        });

        // Fallback to polling if WebSocket is not available
        if (typeof io === 'undefined') {
            console.log('WebSocket not available, falling back to polling');
            // Poll for new messages every 5 seconds
            setInterval(function() {
                syncMessages();
            }, 5000);
        }
    }

    // Function to get the ID of the last message in the conversation
    function getLastMessageId() {
        const messages = document.querySelectorAll('.message');
        if (messages.length === 0) return 0;

        const lastMessage = messages[messages.length - 1];
        return lastMessage.dataset.messageId;
    }

    // Function to append a new message to the conversation
    function appendMessage(message) {
        const conversation = document.querySelector('.conversation');
        const isCurrentUser = message.sender_id === {{ current_user.id }};
        const messageClass = isCurrentUser ? 'message-sent' : 'message-received';
        const deletedClass = message.deleted ? 'message-deleted' : '';
        const editedClass = message.edited ? 'message-edited' : '';

        // Create message element
        const messageElement = document.createElement('div');
        messageElement.className = `message ${messageClass}`;
        messageElement.dataset.messageId = message.id;

        // Create message content
        let messageHTML = `
            <div class="message-content ${deletedClass} ${editedClass}">
                ${message.content}
                <div class="message-time">
                    ${new Date(message.created_at).toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })} |
                    ${new Date(message.created_at).toLocaleString('en-US', { month: 'short', day: 'numeric' })}
        `;

        // Add edited indicator
        if (message.edited) {
            messageHTML += `<span class="text-muted ms-1">(edited)</span>`;
        }

        // Add read/delivered indicators for sent messages
        if (isCurrentUser) {
            if (message.read) {
                messageHTML += `<span class="text-primary ms-1" title="Read"><i class="fas fa-check-double"></i></span>`;
            } else if (message.delivered) {
                messageHTML += `<span class="text-primary ms-1" title="Delivered"><i class="fas fa-check"></i></span>`;
            }

            // Add message actions dropdown for current user's messages
            if (!message.deleted) {
                messageHTML += `
                    <div class="message-actions dropdown">
                        <button class="btn btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="/messages/message/${message.id}/edit">
                                    <i class="fas fa-edit me-2"></i> Edit
                                </a>
                            </li>
                            <li>
                                <form action="/messages/message/${message.id}/delete" method="POST">
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="fas fa-trash-alt me-2"></i> Delete
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                `;
            }
        }

        messageHTML += `
                </div>
            </div>
        `;

        messageElement.innerHTML = messageHTML;
        conversation.appendChild(messageElement);

        // Mark message as delivered if it's received
        if (!isCurrentUser && !message.delivered) {
            fetch(`/messages/api/messages/${message.id}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: 'delivered' }),
            }).catch(error => console.error('Error marking message as delivered:', error));
        }
    }

    // Function to set up typing indicator
    function setupTypingIndicator() {
        const messageInput = document.getElementById('message-input');
        const username = '{{ user.username }}';
        let typingTimeout;

        messageInput.addEventListener('input', function() {
            // Clear previous timeout
            clearTimeout(typingTimeout);

            // Send typing status via WebSocket
            if (typeof sendTypingStatus === 'function') {
                sendTypingStatus(username, true);
            }

            // Set new timeout to hide typing indicator after 2 seconds of inactivity
            typingTimeout = setTimeout(function() {
                // Send stopped typing status
                if (typeof sendTypingStatus === 'function') {
                    sendTypingStatus(username, false);
                }
            }, 2000);
        });

        // Clear typing status when focus is lost
        messageInput.addEventListener('blur', function() {
            clearTimeout(typingTimeout);
            if (typeof sendTypingStatus === 'function') {
                sendTypingStatus(username, false);
            }
        });
    }

    // Function to set up message form with AJAX submission
    function setupMessageForm() {
        const form = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const clientMessageIdField = document.querySelector('input[name="client_message_id"]');
        const attachmentInput = document.getElementById('attachment-upload');
        const attachmentPreview = document.getElementById('attachment-preview');
        const username = '{{ user.username }}';

        form.addEventListener('submit', function(e) {
            e.preventDefault();

            // Get form data
            const content = messageInput.value.trim();
            if (!content && !attachmentInput.files.length) {
                // Require either text content or an attachment
                return;
            }

            // Generate a new client message ID
            const clientMessageId = uuid4();
            clientMessageIdField.value = clientMessageId;

            // Disable form while sending
            messageInput.disabled = true;
            sendButton.disabled = true;
            if (attachmentInput) attachmentInput.disabled = true;

            // Clear input immediately to prevent duplicate submissions
            const contentToSend = content;
            messageInput.value = '';

            // Check if we have an attachment
            const hasAttachment = attachmentInput && attachmentInput.files.length > 0;

            // If we have an attachment, we need to use FormData and can't use WebSockets
            if (hasAttachment) {
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('content', contentToSend);
                formData.append('client_message_id', clientMessageId);
                formData.append('attachment', attachmentInput.files[0]);

                // Send via API with file upload
                fetch(`/messages/api/messages/${username}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(message => {
                    // Clear attachment preview
                    if (attachmentPreview) attachmentPreview.classList.add('d-none');
                    if (attachmentInput) attachmentInput.value = '';

                    // Append message to conversation
                    appendMessage(message);

                    // Scroll to bottom
                    const conversation = document.querySelector('.conversation');
                    conversation.scrollTop = conversation.scrollHeight;
                })
                .catch(error => {
                    console.error('Error sending message with attachment:', error);
                    alert('Failed to send message with attachment. Please try again.');
                })
                .finally(() => {
                    // Re-enable form
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                    if (attachmentInput) attachmentInput.disabled = false;
                    messageInput.focus();
                });
            } else {
                // No attachment, try WebSocket first
                if (typeof sendMessageViaSocket === 'function' && isConnected) {
                    sendMessageViaSocket(username, contentToSend, clientMessageId)
                        .then(message => {
                            // Message sent successfully via WebSocket
                            console.log('Message sent via WebSocket:', message);
                        })
                        .catch(error => {
                            console.error('Error sending message via WebSocket:', error);
                            // Fall back to API
                            sendMessageViaAPI(username, contentToSend, clientMessageId);
                        });
                } else {
                    // Fall back to API
                    sendMessageViaAPI(username, contentToSend, clientMessageId);
                }
            }

            // Function to send message via API
            function sendMessageViaAPI(username, content, clientMessageId) {
                fetch(`/messages/api/messages/${username}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: content,
                        client_message_id: clientMessageId
                    }),
                })
                .then(response => response.json())
                .then(message => {
                    // Append message to conversation if not already there
                    const existingMessage = document.querySelector(`.message[data-message-id="${message.id}"]`) ||
                                           document.querySelector(`.message[data-client-id="${clientMessageId}"]`);

                    if (!existingMessage) {
                        appendMessage(message);
                    }

                    // Scroll to bottom
                    const conversation = document.querySelector('.conversation');
                    conversation.scrollTop = conversation.scrollHeight;
                })
            }
            .catch(error => {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            })
            .finally(() => {
                // Re-enable form
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            });
        });
    }

    // Function to mark all unread messages as read
    function markAllMessagesAsRead() {
        const messages = document.querySelectorAll('.message.message-received');
        messages.forEach(messageEl => {
            const messageId = messageEl.dataset.messageId;
            if (messageId) {
                markMessageAsRead(messageId);
            }
        });
    }
</script>
{% endblock %}
