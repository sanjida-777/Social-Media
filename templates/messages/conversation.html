{% extends "base.html" %}

{% block title %}Conversation with {{ user.username }}{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/messages.css') }}">
{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-md-3">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Messages</h5>
            </div>
            <div class="list-group list-group-flush">
                <a href="{{ url_for('messages.inbox') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-inbox me-2"></i> Inbox
                </a>
                <a href="{{ url_for('messages.sent') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-paper-plane me-2"></i> Sent
                </a>
                <a href="{{ url_for('messages.new_message') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-plus me-2"></i> New Message
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <img src="{{ url_for('static', filename='img/profile_pics/' + user.profile_image) }}"
                         alt="Profile Picture" class="rounded-circle profile-pic-small me-2">
                    <h5 class="mb-0">{{ user.first_name }} {{ user.last_name }}</h5>
                </div>
                <a href="{{ url_for('profile.view', username=user.username) }}" class="btn btn-light btn-sm">
                    <i class="fas fa-user me-1"></i> View Profile
                </a>
            </div>
            <div class="card-body conversation-container">
                <div class="offline-message">
                    <i class="fas fa-exclamation-triangle me-2"></i> You are currently offline. Messages will be sent when you reconnect.
                </div>
                <div class="conversation">
                    {% for message in messages.items %}
                    <div class="message {% if message.sender == current_user %}message-sent{% else %}message-received{% endif %}" data-message-id="{{ message.id }}">
                        <div class="message-content {% if message.deleted %}message-deleted{% endif %} {% if message.edited %}message-edited{% endif %}">
                            {{ message.content }}
                            <div class="message-time">
                                {{ message.created_at.strftime('%I:%M %p | %b %d') }}
                                {% if message.edited %}
                                <span class="text-muted ms-1">(edited)</span>
                                {% endif %}
                                {% if message.sender == current_user %}
                                    {% if message.read %}
                                    <span class="message-status read-status ms-1" title="Read {{ message.read_at.strftime('%I:%M %p | %b %d') if message.read_at else '' }}"><i class="fas fa-check-double"></i></span>
                                    {% elif message.delivered %}
                                    <span class="message-status delivered-status ms-1" title="Delivered {{ message.delivered_at.strftime('%I:%M %p | %b %d') if message.delivered_at else '' }}"><i class="fas fa-check"></i></span>
                                    {% else %}
                                    <span class="message-status sent-status ms-1" title="Sent"><i class="fas fa-paper-plane"></i></span>
                                    {% endif %}

                                    <!-- Message actions dropdown -->
                                    {% if not message.deleted %}
                                    <div class="message-actions dropdown">
                                        <button class="btn btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" href="{{ url_for('messages.edit_message', message_id=message.id) }}">
                                                    <i class="fas fa-edit me-2"></i> Edit
                                                </a>
                                            </li>
                                            <li>
                                                <form action="{{ url_for('messages.delete_message', message_id=message.id) }}" method="POST">
                                                    <button type="submit" class="dropdown-item text-danger">
                                                        <i class="fas fa-trash-alt me-2"></i> Delete
                                                    </button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Message Form -->
                <form class="mt-3" id="message-form">
                    {{ form.hidden_tag() }}
                    {{ form.recipient(type="hidden") }}
                    {{ form.client_message_id(type="hidden") }}
                    <div class="input-group">
                        {{ form.content(class="form-control", placeholder="Type a message...", rows="1", id="message-input") }}
                        <button type="submit" class="btn btn-primary" id="send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="typing-indicator mt-1 d-none">
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/messages.js') }}"></script>
<script>
    // Generate UUID for client message ID
    function uuid4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // Scroll to bottom of conversation on page load
    document.addEventListener('DOMContentLoaded', function() {
        const conversationContainer = document.querySelector('.conversation');
        conversationContainer.scrollTop = conversationContainer.scrollHeight;

        // Set up real-time message updates
        setupMessagePolling();

        // Set up typing indicator
        setupTypingIndicator();

        // Set up message form with AJAX submission
        setupMessageForm();
    });

    // Function to poll for new messages
    function setupMessagePolling() {
        const username = '{{ user.username }}';
        const conversation = document.querySelector('.conversation');
        let lastMessageId = getLastMessageId();

        // Poll for new messages every 5 seconds
        setInterval(function() {
            fetch(`/messages/api/messages/${username}?since_id=${lastMessageId}`)
                .then(response => response.json())
                .then(messages => {
                    if (messages.length > 0) {
                        // Update the UI with new messages
                        messages.forEach(message => {
                            appendMessage(message);
                        });

                        // Update the last message ID
                        lastMessageId = messages[0].id;

                        // Scroll to bottom
                        conversation.scrollTop = conversation.scrollHeight;
                    }
                })
                .catch(error => console.error('Error fetching messages:', error));
        }, 5000);
    }

    // Function to get the ID of the last message in the conversation
    function getLastMessageId() {
        const messages = document.querySelectorAll('.message');
        if (messages.length === 0) return 0;

        const lastMessage = messages[messages.length - 1];
        return lastMessage.dataset.messageId;
    }

    // Function to append a new message to the conversation
    function appendMessage(message) {
        const conversation = document.querySelector('.conversation');
        const isCurrentUser = message.sender_id === {{ current_user.id }};
        const messageClass = isCurrentUser ? 'message-sent' : 'message-received';
        const deletedClass = message.deleted ? 'message-deleted' : '';
        const editedClass = message.edited ? 'message-edited' : '';

        // Create message element
        const messageElement = document.createElement('div');
        messageElement.className = `message ${messageClass}`;
        messageElement.dataset.messageId = message.id;

        // Create message content
        let messageHTML = `
            <div class="message-content ${deletedClass} ${editedClass}">
                ${message.content}
                <div class="message-time">
                    ${new Date(message.created_at).toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })} |
                    ${new Date(message.created_at).toLocaleString('en-US', { month: 'short', day: 'numeric' })}
        `;

        // Add edited indicator
        if (message.edited) {
            messageHTML += `<span class="text-muted ms-1">(edited)</span>`;
        }

        // Add read/delivered indicators for sent messages
        if (isCurrentUser) {
            if (message.read) {
                messageHTML += `<span class="text-primary ms-1" title="Read"><i class="fas fa-check-double"></i></span>`;
            } else if (message.delivered) {
                messageHTML += `<span class="text-primary ms-1" title="Delivered"><i class="fas fa-check"></i></span>`;
            }

            // Add message actions dropdown for current user's messages
            if (!message.deleted) {
                messageHTML += `
                    <div class="message-actions dropdown">
                        <button class="btn btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="/messages/message/${message.id}/edit">
                                    <i class="fas fa-edit me-2"></i> Edit
                                </a>
                            </li>
                            <li>
                                <form action="/messages/message/${message.id}/delete" method="POST">
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="fas fa-trash-alt me-2"></i> Delete
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                `;
            }
        }

        messageHTML += `
                </div>
            </div>
        `;

        messageElement.innerHTML = messageHTML;
        conversation.appendChild(messageElement);

        // Mark message as delivered if it's received
        if (!isCurrentUser && !message.delivered) {
            fetch(`/messages/api/messages/${message.id}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: 'delivered' }),
            }).catch(error => console.error('Error marking message as delivered:', error));
        }
    }

    // Function to set up typing indicator
    function setupTypingIndicator() {
        const messageInput = document.getElementById('message-input');
        const typingIndicator = document.querySelector('.typing-indicator');
        let typingTimeout;

        messageInput.addEventListener('input', function() {
            // Show typing indicator on the other side
            // In a real app, this would send a typing event to the server

            // Clear previous timeout
            clearTimeout(typingTimeout);

            // Set new timeout to hide typing indicator after 2 seconds of inactivity
            typingTimeout = setTimeout(function() {
                // Hide typing indicator
                // In a real app, this would send a stopped typing event to the server
            }, 2000);
        });
    }

    // Function to set up message form with AJAX submission
    function setupMessageForm() {
        const form = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const clientMessageIdField = document.querySelector('input[name="client_message_id"]');
        const username = '{{ user.username }}';

        form.addEventListener('submit', function(e) {
            e.preventDefault();

            // Get form data
            const content = messageInput.value.trim();
            if (!content) return;

            // Generate a new client message ID
            const clientMessageId = uuid4();
            clientMessageIdField.value = clientMessageId;

            // Disable form while sending
            messageInput.disabled = true;
            sendButton.disabled = true;

            // Send message via API
            fetch(`/messages/api/messages/${username}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: content,
                    client_message_id: clientMessageId
                }),
            })
            .then(response => response.json())
            .then(message => {
                // Clear input
                messageInput.value = '';

                // Append message to conversation
                appendMessage(message);

                // Scroll to bottom
                const conversation = document.querySelector('.conversation');
                conversation.scrollTop = conversation.scrollHeight;
            })
            .catch(error => {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            })
            .finally(() => {
                // Re-enable form
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            });
        });
    }
</script>
{% endblock %}
